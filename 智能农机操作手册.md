# 智能农机操作手册

## 数据采集

打点程序

```
1.进入到用户目录
 cd /home/szyd
 
2.执行打点程序脚本
 python3 getPoint.py
 
3.监听键盘输入
 x为主干道，y为作业道路,n为主干道路换行，m为作业道路换行,q为退出打点程序
 
4.打完点以后，数据会保存到/home/szyd/gps.csv文件中
```

注意事项：`当GPS精度不够会报错，需要重新打点`

       `除x,y,n,m,q其他输入均为无效输入`

## 数据处理

采用到的工具为：`QGIS 3.22.1`	`pgAdmin 4`  

### 导入数据

#### 第一步：新建工程

![image-20220108102744890](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108102744890.png)



#### 第二步：载入数据

![image-20220108102906540](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108102906540.png)



![image-20220108103426360](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108103426360.png)



#### 第三步：数据处理

在上一步加载完成的文件上，单击右键，选择导出，Save Features As.

![image-20220108114247494](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108114247494.png)

导出格式为 Shapefile， 数据格式为 WGS 84.

![image-20220108114941574](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108114941574.png)

选择文件存放位置和文件名字，类型为 Shapefile

![image-20220108114915575](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108114915575.png)

选中之前的源文件，点击删除图层

![image-20220108134811343](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108134811343.png)

只留下我们需要进行数据处理的图层

![image-20220108135716477](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108135716477.png)

将 OpenStreetMap 图层添加到显示 Layers界面

![image-20220108140125573](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108140125573.png)

添加后如图所示，将其拖动置于最下层，方便后续对地图路线进行修改

![image-20220108140249431](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108140249431.png)

在视图中央能看到采集的所有的点的数据显示在 OSM 地图上

![image-20220108140413908](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108140413908.png)



接下来进行数据的加工了修改，在上方导航栏中调出工具箱 Toolbox

![image-20220108141124282](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108141124282.png)

在 工具箱的搜索栏里搜索 points to path（由点生成线）

![image-20220108142416711](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108142416711.png)

双击进入界面，执行点转线的操作

![image-20220108142645153](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108142645153.png)

程序执行完之后，在左侧 Layers 界面会多出一个图层，名字默认为 Paths，根据Paths的连线情况，对数据图层 gps 进行修改

![image-20220108142940895](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108142940895.png)

![image-20220108143134266](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108143134266.png)

为了方便捕捉顶点，可以打开捕捉工具

在导航栏空白处单击右键，勾选 Snapping Toolbar

![image-20220108143451958](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108143451958.png)

之后导航栏会出现一个磁铁形状的工具。将其选中即可实现顶点和交叉点捕捉，如图所示，灰色背景的按钮表示选中

![image-20220108143635348](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108143635348.png)

接下来就可以进行修改

移动数据点的流程为：鼠标左键单击需要修改的点就可以拾取该点，然后在你想要移动到的任意位置单击鼠标左键，即可将点放置到该位置处。

![image-20220108144042691](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108144042691.png)

![image-20220108144136356](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108144136356.png)

数据点修改完之后就需要重新对道路进行连线，在此之前先移除之前作为数据点修改参考依据的Paths图层。

![image-20220108144342465](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108144342465.png)

重新点击右侧工具箱（Processing Toolbox）中的 Points to path 功能，进行点转线，即可得到我们最终需要的路线图

![image-20220108144535480](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108144535480.png)

![image-20220108144803111](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108144803111.png)



### 导出数据

#### 第一步：将数据导入到数据库

连接数据库，选择导航栏中的Database

![image-20220108152129489](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108152129489.png)

数据库类型选择 PostGIS

![image-20220108152115041](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108152115041.png)

输入账号密码，连接到数据库

![image-20220108152309379](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108152309379.png)

连接上数据库之后，点击上方的Import Layer/File...

![image-20220108152421931](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108152421931.png)

导入选项：

- 选择数据源，即QGIS中生成的Paths图层
- 选择库，默认为public
- 选择表，优先选择road_lines
- 勾选如图所示的 options
- 点击ok，即可完成导入

![image-20220108152751406](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108152751406.png)



#### 第二步：在数据库操作数据

运行 PgAdmin 4，进行数据库的操作

创建数据库连接

- 选中 Servers，单击右键
- create -- Server

![image-20220108161149871](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108161149871.png)

- 输入Name： 自定义的名字，随便输入

  ![image-20220108161406233](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108161406233.png)

- 输入Host，即服务器地址，Username默认为postgres，在Password位置输入数据库连接密码。

  ![image-20220108161627010](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108161627010.png)

- 点击Save，即可完成数据库连接的创建

进入到数据库进行下一步操作：

- 依次展开，即可看到项目所对应的库和表

![image-20220108164253194](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108164253194.png)

在任意一个表名位置处，单击右键，选择 Query TOOl，即可进入数据库操作界面。

![image-20220108162215547](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108162215547.png)

在Query Editor编辑器位置输入命令即可进行数据库操作，接下来的操作都在此处进行。

![image-20220108162345269](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108162345269.png)

处理数据：

- 查看当前的路线表中最大的groups的值

  ```
  select max(groups) from road
  ```

  ![image-20220108164421904](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108164421904.png)

- 更新数据源库表中的groups字段的值

  ```
  update road_lines set groups = groups+41 where groups > 0
  update road_lines set groups = 0 where groups < 0
  ```

- 将数据源表中的数据插入到路线表中

  ```
  insert into road (geom,groups) select geom,groups from road_lines
  ```

- 删除表 road_vertices_pgr

  ```
  drop table road_vertices_pgr
  ```

- 重新生成source，target字段

  ```
  alter table road drop column source
  alter table road drop column target
  alter table road add column source bigint
  alter table road add column target bigint
  ```

- 生成拓扑

  ```
  SELECT  pgr_createTopology('road', 0.000000000001, the_geom:='geom', id:='id', source:='source', target:='target')
  ```

- 更新字段的值

  ```
  update road set cost = 1,reverse_cost=1
  update road set type = 1 where groups != 0
  update road set type = 0 where groups = 0
  ```

至此，数据库的操作结束

###  导出GeoServer图层文件

#### 第一步：加载数据库数据

打开QGIS，选择新建图层

![image-20220108170726154](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108170726154.png)

从数据库载入图层

- 选择PostgreSQL数据库
- 选择对应的库名 ccrs
- 点击连接
- 选择 public
- 选择数据存放的表 road
- 点击add ，添加到QGIS

![image-20220108171142679](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108171142679.png)

#### 第二步：样式加载

下载事先完成好的样式文件

https://e.gitee.com/cclient/docs?directory=832438&page=1&program_id=0&scope=root

双击 road 图层，进入属性编辑页面，

- 点击左下角 Style
- 点击Load Style

![image-20220108155634639](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108155634639.png)

- 选择从文件加载样式 From File
- 选择下载好的样式文件 test_road.sld
- Load Style

![image-20220108155904152](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108155904152.png)

- 取消勾选 type is ''

  ![image-20220108171409918](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108171409918.png)

- 点击apply，即可看到样式已经加载到road图层

#### 第三步：文件导出

从服务器上下载之前的图层文件

路径为：`/home/szyd/test_road`

在QGIS中的road图层上单击右键选择导出，File name选择之前从服务器上下载的对应的文件名

![image-20220108171736496](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108171736496.png)

点击ok，即可将文件导出

![image-20220108171824682](C:\Users\cclient\AppData\Roaming\Typora\typora-user-images\image-20220108171824682.png)

将文件夹重新上传到服务器的对应位置，进行覆盖，这样即可实现Geoserver 图层的自动更新。